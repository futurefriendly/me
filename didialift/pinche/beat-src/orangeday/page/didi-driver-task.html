<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>滴滴顺风车</title>
    <link rel="stylesheet" type="text/css" href="/static/common/css/merged-common-ui.css">
    <link rel="stylesheet"  href="../static/css/didi-orange.css">
</head>
<body>

         <!-- 横屏提示层 -->
         <div class="wrong-layer-one fullLayer-one" id="wrongLayer">
            <div class="abs-mm ta-c">
                <img src="http://static.xiaojukeji.com/pinche/images/subwaydog/wrong.png" style="width:74px;height:110px;">
                <br>
                <div class="placeBlock-20"></div>
                <span class="size14" style="color:#fff;font-size:1.4rem">为了更好的体验，请使用竖屏浏览</span>
            </div>
         </div>

         <script type="text/javascript">
           var fullLayerOne = document.querySelector('.fullLayer-one');
           if(window.innerHeight>window.innerWidth){
              fullLayerOne.style.height= window.innerWidth + "px";
           }else{
              fullLayerOne.style.height= window.innerHeight + "px";
           }
        </script>

       <input type="hidden" value="2" id="task">
        <!-- 顶部logo -->
        <div class="didi-orange-title">
            <img src="../static/img/didi-driver-title.jpg">
        </div>

        <!-- 活动内容 -->
        <div class="didi-orange-task borderB">
            <div class="didi-task-pic">
                <img src="../static/img/4.jpg">
            </div>
            <h1>邀请奖励无上限</h1>
            <p>每邀请1位好友成为车主（且他在桔色星期一完成1单）可获得<span style="color:#ff8903">20-30元</span>奖励，奖励次数无上限</p>
        </div>

        <div class="didi-orange-task">
            <div class="didi-task-pic">
                <img src="../static/img/3.jpg">
            </div>
            <h1>周一接单拿奖励</h1>
            <p>桔色星期一当天接单，车主奖励增加50%</p>
        </div>

        <div class="bottom-none" id="task-bottom">
        <!-- 判断登录状态 -->
            <a href="javascript:void(0)" class="go-task" id="go-task"></a>
            <a href="<?php echo $backurl;?>" class="go-back">查看乘客奖励
                <span class="arrow"><img src="../static/img/arrow.jpg"></span>
            </a>
        </div>

        <!-- 验证码 -->
        <div class="didi-dilog didi-code-alert">
             <div class="content_tel">
                 <!-- 关闭按钮 -->
                 <div class="didi-close">
                    <img src="../static/img/didi-close.png">
                 </div>
                 <ul class="cont_ul">
                     <li><p>验证手机号,奖励才能找到你哦</p></li>
                     <li class="li_phone form">
                        <input type="tel" placeholder="填写手机号" id="phone" class="phone_i" maxlength="11"><a href="javascript:;" id="btnCheck" class="btnCheck">验证</a>
                     </li>
                     <li class="form">
                        <input type="tel" placeholder="输入验证码" id="code" class="valide_i"  maxlength="4">
                     </li>
                     <li>
                        <a href="javascript:void(0);" class="chose_btn" id="chose_btn">确定</a>
                        <!-- <p>奖励发送到手机号对应的滴滴账户</p> -->
                     </li>
                 </ul>
             </div>
        </div>
        
<script src="/static/common/js/zepto.js"></script>
<script type="text/javascript" src="/static/common/js/merged-base-dialog.js"></script>

<script>
function orient() {
        if (window.orientation == 0 || window.orientation == 180) {
        $('#wrongLayer').hide();
        return false;
        }
        else if (window.orientation == 90 || window.orientation == -90) {
        $('#wrongLayer').show();
        return false;
        }
        }
        $(window).bind('orientationchange', function(e){
            orient();
});


$(window).on('load', function(){
    var phone = $("#phone"),
        code = $("#code"),
        btnSubmit = $("#chose_btn"),
        btnCheck = $("#btnCheck"),
        goTask = $("#go-task"),
        close = $('.didi-close'),
        task = $('#task'),
        invitephoneText = /[?&]invitephone=([^&]*)/.test(location.search) && RegExp.$1,
        channelText = /[?&]channel=(\d+)/.test(location.search) && RegExp.$1,
        fappText = /[?&]fapp=([^&]*)/.test(location.search) && RegExp.$1,
        appversionText = /[?&]appversion=([^&]+)/.test(location.search) && RegExp.$1,
        nativetypeText ="",
        ua = navigator.userAgent.toLowerCase(),
        countdown = 60;
    var reg1=/^1[3|4|5|8|7][0-9]\d{8}$/; 
    
 
        // 获取invitephone值
        if(invitephoneText){
            invitephoneValues = invitephoneText;
        }else{
            invitephoneValues=0
        }

        // 获取channel值
        if(channelText){
            channelValues = parseInt(channelText);
        }else{
            channelValues=0
        }

        // 获取appversion值
        if(appversionText){
            appversionValue = appversionText;
            // 版本号转换
            var reg = /[^\d]/g;
            appversionNum = appversionText.replace( reg, '' );
        }else{
            appversionValue=0
        }

        //获取fapp值，更改按钮文案
        if(fappText){
            goTask.html("认证车主拿奖励")
        }else{
            goTask.html("马上拿奖励")
        }  

        // 判断安卓或者IOS端
        if(window.DidiJSBridge){
                if (/iphone|ipad|ipod/.test(ua)) {
                        nativetypeText = "ios";
                } else if (/android/.test(ua)){
                        nativetypeText = "android";
                }
            }else{
                 nativetypeText = 0;
        }


        // 端内流程
        goTask.bind('touchend',function(){
            var _this=$(this);
            if($(this).hasClass('hover')){
                return;
            }
            $(this).addClass('hover'); 
            $.ajax({
                type:'GET',
                url:'<?php echo $dotaskurl;?>',
                data:{'appversion':appversionValue,'nativetype':nativetypeText},
                timeout:'5000',
                success:function(data){
                _this.removeClass('hover');
                var da=JSON.parse(data);
                    console.log(da);                
                    if(da.errno==0){
                        location.href=da.data.url;
                    }else if(da.errno==101){   //验证码
                       $('.didi-code-alert').css('display','block');
                    }else if(da.errno==106){   
                      on105errno(da)
                    }
                },
                error:function(){
                    _this.removeClass('hover');
                    dd.dialog.alert("网络请求失败，请稍后重试");
                }
            });
        })


    btnSubmit.bind('touchend',function(){
        var _this=$(this);

        if(!reg1.test(phone.val())){
          $('.didi-code-alert').css('display','none');
          dd.dialog.alert({tip:"请输入正确的手机号码",btn:{val:'确定',handler:function(){
               $('.didi-code-alert').css('display','block')
           }}});
          return;
        }

        if(code.val()==''){
          $('.didi-code-alert').css('display','none');
          dd.dialog.alert({tip:"验证码不能为空",btn:{val:'确定',handler:function(){
               $('.didi-code-alert').css('display','block')
           }}});
            return
        }
       
        phone.blur();
        code.blur();
        $.ajax({
            type:'POST',
            url:'<?php echo $url_login;?>',
            data:{'phone':phone.val(),'code':code.val(),'invitephone':invitephoneValues,'channel':channelValues,'task':task.val(),'appversion':appversionValue,'nativetype':nativetypeText},
            timeout:'5000',
            success:function(data){
                console.log(data);
                var da=JSON.parse(data);    
                if(da.errno==0){
                    if(da.registered == 0){
                            window.location.href=da.data.url;
                    }else{
                            window.location.href=da.data.url;
                    }
                }
                else if(da.errno == 104){
                            location.href=da.data.url;
                }

                else if(da.errno==106){   
                            //端内登陆弹出提示层
                        on105errno(da);
                    }
                else{
                        $('.didi-code-alert').css('display','none');
                        dd.dialog.alert({tip:da.errmsg,btn:{val:'确定',handler:function(){
                           $('.didi-code-alert').css('display','block')
                        }}});
                }

            },
            error:function(){
                        $('.didi-code-alert').css('display','none');
                        dd.dialog.alert({tip:"网络请求失败,请稍后重试",btn:{val:'确定',handler:function(){
                           $('.didi-code-alert').css('display','block')
                        }}});
            }
        })
    });


    close.bind('touchend',function(){
        phone.blur();
        code.blur();
       $('.didi-dilog').css('display','none');
        event.preventDefault();
    })

    //验证
    btnCheck.bind('touchend',function(){
        var _this=$(this);
         if(phone.val() == ""){
          $('.didi-code-alert').css('display','none');
          dd.dialog.alert({tip:"手机不能为空",btn:{val:'确定',handler:function(){
               $('.didi-code-alert').css('display','block')
           }}});
          return;
        }
        if(!reg1.test(phone.val())){
          $('.didi-code-alert').css('display','none');
          dd.dialog.alert({tip:"手机号填写有误",btn:{val:'确定',handler:function(){
               $('.didi-code-alert').css('display','block')
           }}});
          return;
        }

        if(btnCheck.hasClass('btnGray')) {
            return
        }
        
            phone.blur();
            code.blur();
            $.ajax({
                url:'<?php echo $url_getcode;?>'+ phone.val(),
                timeout:'5000',
                success:function(data){
                    var json=JSON.parse(data);

                    console.log(json);
                    if (json.errno == 0) {
                        code.focus();
                        settime();
                        btnCheck.addClass('btnGray');
                    } else if (json.errno == 1008) {
                        dd.dialog.alert("您将来接到电话通知您验证码，请注意查收");
                        code.focus();
                        settime();
                        btnCheck.addClass('btnGray');
                    } else {
                        $('.didi-code-alert').css('display','none');
                        dd.dialog.alert({tip:json.errmsg,btn:{val:'确定',handler:function(){
                           $('.didi-code-alert').css('display','block')
                        }}});
                    }
                },
                error:function(){
                        $('.didi-code-alert').css('display','none');
                        dd.dialog.alert({tip:"网络请求失败,请稍后重试",btn:{val:'确定',handler:function(){
                           $('.didi-code-alert').css('display','block')
                        }}});
                }
            })
    });

              
    
    //倒计时
    function settime() {
        if (countdown == 0) {
            btnCheck.removeClass('btnGray');
            btnCheck.html("验证");
            countdown = 60;
            return;
        } else {
            btnCheck.addClass("btnGray");
            btnCheck.html(countdown + "s");
            countdown--;
        }
        setTimeout(function() {
            settime();
        }, 1000);
    }


    var docHeight = parseInt(document.body.scrollHeight),
        winInHi = parseInt(window.innerHeight),
        taskB = document.getElementById('task-bottom');

    if(docHeight > winInHi){
           taskB.className="didi-task-bottom"
    }else{
           taskB.className="didi-task-bottom-p"
    }



    function on105errno(da){
        //端内登陆弹出提示层
        var  onOff = false;   //true不兼容 false 兼容
        var  appOff = true;  //true审核不通过  false 审核通过
        var  onclickOff = true;
        if(onOff){  
                //不兼容
                $('.didi-code-alert').css('display','none');
                dd.dialog.alert({title:da.errtitle,tip:da.errmsg,btn:{val:'我知道了',handler:function(){
                    }
                }});   
        }else{
            if(/iphone|ipad|ipod/.test(ua)){
                if(appOff){ //审核不通过
                    $('.didi-code-alert').css('display','none');
                    dd.dialog.alert({title:da.errtitle,tip:da.errmsg,btn:{val:'我知道了',handler:function(){
                        }
                    }});                                          
                }else{
                    if( parseInt(appversionNum ) < 394){
                      if(onclickOff){
                         $('.didi-code-alert').css('display','none');
                         dd.dialog.confirm({
                            text : "你的客户端版本太旧,更新后就能获取车主奖励",
                            cancel : {
                                val: "不更新",
                                    handler: function(t) {
                                    dd.dialog.alert({title:da.errtitle,tip:da.errmsg,btn:{val:'我知道了',handler:function(){
                                        }
                                    }});   
                                }
                            },
                            confirm : 
                            {
                                val: "更新",
                                handler: function(t) {
                                window.location.href="http://diditaxi.com.cn/api/v1/share"
                               }
                            }
                        });  
                       }else{
                            $('.didi-code-alert').css('display','none');
                            dd.dialog.alert({title:da.errtitle,tip:da.errmsg,btn:{val:'我知道了',handler:function(){
                                }
                            }});     
                       } 
                       onclickOff = false;
                    } 
                }
            }else if (/android/.test(ua)){
                    if( parseInt(appversionNum ) < 394){
                      if(onclickOff){
                         $('.didi-code-alert').css('display','none');
                         dd.dialog.confirm({
                            text : "你的客户端版本太旧,更新后就能获取车主奖励",
                            cancel : {
                                val: "不更新",
                                    handler: function(t) {
                                    dd.dialog.alert({title:da.errtitle,tip:da.errmsg,btn:{val:'我知道了',handler:function(){
                                        }
                                    }});   
                                }
                            },
                            confirm : 
                            {
                                val: "更新",
                                handler: function(t) {
                                window.location.href="http://diditaxi.com.cn/api/v1/share"
                               }
                            }
                        });  
                       }else{
                            $('.didi-code-alert').css('display','none');
                            dd.dialog.alert({title:da.errtitle,tip:da.errmsg,btn:{val:'我知道了',handler:function(){
                                }
                            }});     
                       } 
                       onclickOff = false;
                    } 
            };
        }
    }
    
})
</script>
<script type="text/javascript" src="/static/common/js/app-wx-share.js"></script>
<script type="text/javascript">
$(function(){
       var shareTitle = '<?php echo $shareinfo["share_title"]; ?>',
        shareDesc = '<?php  echo $shareinfo["share_wording"]; ?>',
        shareLink = '<?php  echo $shareinfo["share_url"]; ?>',
        shareImgUrl = '<?php echo $shareinfo["share_logo"]; ?>';

        initWxShare({
            title: shareTitle,
            desc: shareDesc,
            link: shareLink, 
            imgUrl: shareImgUrl 
        });
});
</script>
</body>
</html>
