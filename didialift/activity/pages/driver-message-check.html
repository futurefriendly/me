<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <meta content=”telephone=no” name=”format-detection”/>
    <title>身份认证</title>
    <link rel="stylesheet" type="text/css" href="http://static.xiaojukeji.com/webapp/css/merged-common-ui.css">
    <style>
        html, body {
            background-color: #fff;
            font-family: 'PingFang SC', 'Helvetica Neue', '黑体', STHeitiSC-Light, Helvetica-Light, arial, sans-serif, 'Droid Sans Fallback';
        }

        header {
            min-height: 247px;
        }

        header a {
            display: inline-block;
        }

        input {
            -webkit-appearance: none; /*去除input默认样式*/
        }

        .title {
            color: #808080;
            font-size: 1.5rem;
            text-align: center;
            padding: 30px 0 10px;
        }

        .title em {
            color: #ff8901;
            font-style: normal;
        }

        .success {
            width: 89%;
            margin: auto;
            border-bottom: 1px solid #e6e6e6;
        }

        .input-box {
            width: 90%;
            margin: auto;
            text-align: center;
            margin-top: 10px;

        }

        .input-card-box {
            width: 88%;
            border-bottom: 1px solid #e6e6e6;
        }

        input, select {
            text-align: center;

            padding-bottom: 11px;

            color: #b3b3b3;
        }

        input .card {
            width: 89%;

        }

        ::-webkit-input-placeholder {
            color: #cccccc;
        }

        .btn-box {
            width: 94%;
            margin: 30px auto;
        }

        .card-input {
            width: 100%;
            font-size: 1.7rem;

        }

        .area-select select {
            width: 100%;
            font-size: 1.5rem;
        }

        .area-select span {
            width: 31%;
            display: inline-block;
            border-bottom: 1px solid #e6e6e6;
        }

        .area-select span:nth-child(2) {
            margin: 0 1%;
        }

        .area-text {
            width: 89%;
            margin: auto;
            font-size: 1.5rem;
            color: #b3b3b3;
            text-align: center;
            border-bottom: 1px solid #e6e6e6;
            padding-bottom: 30px;
        }

        .card-text {
            width: 89%;
            margin: auto;
            font-size: 1.7rem;
            color: #b3b3b3;
            text-align: center;
            padding-bottom: 30px;
        }

        .btn-box {
            text-align: center;
            width: 94%;
            height: 42px;
            line-height: 42px;
            border-radius: 5px;
            font-size: 1.6rem;
            text-decoration: none;

        }

        .hide {
            display: none;
        }

        .show {
            display: block;
        }

        footer {
            height: 102px;
        }

        select {

            height: 40px;
            -webkit-appearance: none;
            appearance: none;
            border: none;
            font-size: 18px;
            padding: 0px 10px;
            display: block;
            width: 100%;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            background-color: #FFFFFF;
            color: #b3b3b3;
            border-radius: 4px;
            outline: none;
        }

    </style>
</head>
<body>
<section>
    <header>
        <a href="http://static.diditaxi.com.cn/site/pages/taxi-mis/882.html?v=20160629">
            <img src="http://static.xiaojukeji.com/activity/imgs/driver-message-check/head.jpg?v=20160629" width="100%">
        </a>
        <img src="http://static.xiaojukeji.com/activity/imgs/driver-message-check/success.jpg?v=20160629"
             class="success hide" width="100%">
    </header>
    <div class="content">
        <!--城市-->
        <div class="area-select-box hide">
            <p class="title">请输入您的车辆所属地区</p>

            <p class="input-box area-select">
                <span>
                    <select id="capital">
                        <option value='0' selected>省/市</option>
                    </select>
                </span>
                <span>
                    <select id="city">
                        <option value='0' selected>市</option>
                    </select>
                </span>
                <span>
                    <select id="district">
                        <option value='0' selected>区</option>
                    </select>
                </span>
            </p>
        </div>
        <div class="area-text-box hide">
            <p class="title">您的车辆所属地区<em> [ 已提交 ] </em></p>

            <p class="area-text"></p>
        </div>
        <!--身份证-->
        <div class="card-input-box hide">
            <p class="title">请输入您的身份证号</p>

            <p class="input-box input-card-box">
                <input type="text" class="card-input" placeholder="请输入正确身份证号" maxlength="18">
            </p>
        </div>
        <div class="card-text-box hide">
            <p class="title">您的身份证号<em> [ 已提交 ] </em></p>

            <p class="card-text"></p>
        </div>
    </div>
    <footer>
        <div class="btn-box btn-orange hide">提交</div>
    </footer>


</section>
</body>
</html>

<script type="text/javascript" src="http://static.xiaojukeji.com/webapp/js/merged-base-dialog.js"></script>

<script>

    document.addEventListener('DOMContentLoaded', function () {
        var base = dd.base || {};
        var dialog = dd && dd.dialog;
        var capitalJson = {};
        var cityJson = {};
        var districtJson = {};

        var capital = document.getElementById("capital");
        var city = document.getElementById("city");
        var district = document.getElementById("district");

        var areaSelectBox = document.querySelector(".area-select-box");
        var areaTextBox = document.querySelector(".area-text-box");
        var cardInputBox = document.querySelector(".card-input-box");
        var cardTextBox = document.querySelector(".card-text-box");
        var success = document.querySelector(".success");
        var btnBox = document.querySelector(".btn-box");
        var cardInput = document.querySelector(".card-input");
        var cardText = document.querySelector(".card-text");
        var areaText = document.querySelector(".area-text");
        var content = document.querySelector(".content");

        var submitData = base.getQueryStr();
        var have_driver_area = null;
        var have_card_number = null;

        var baseUrl = "//pay.xiaojukeji.com";//TODO上线
        //var baseUrl = "";

        isApply();
        idCardInfoFn();

        //司机认证资料
        function idCardInfoFn() {
            var loading = dd.dialog.loading("加载中...");
            base.ajax({
                method: "get",
                url: baseUrl + "/api/v2/d_register/idCardInfo" + location.search,
                succFunc: function (data) {
                    loading.hide();
                    var da = base.txtToJson(data);
                    if (da.errno == 0) {
                        var driverInfo = da.data;
                        have_driver_area = driverInfo.have_driver_area;
                        have_card_number = driverInfo.have_card_number;

                        //是否填写了司机省市区
                        if (have_driver_area == 1) {//填了
                            areaTextBox.classList.remove("hide");
                            areaTextBox.classList.add("show");
                            areaText.innerHTML = driverInfo.driver_province_cn + " " + driverInfo.driver_city_cn + " " + driverInfo.driver_county_cn;

                        } else {//没填
                            areaSelectBox.classList.remove("hide");
                            areaSelectBox.classList.add("show");
                            getCity();

                        }

                        //是否填写了身份证号
                        if (have_card_number == 1) {//填了
                            cardTextBox.classList.remove("hide");
                            cardTextBox.classList.add("show");
                            cardText.innerHTML = driverInfo.card_number;


                        } else {//没填
                            cardInputBox.classList.remove("hide");
                            cardInputBox.classList.add("show");
                        }

                        //两项是否都填写
                        if (have_driver_area == 1 && have_card_number == 1) {
                            success.classList.remove("hide");
                            success.classList.add("show");
                        } else {
                            btnBox.classList.remove("hide");
                            btnBox.classList.add("show");
                        }

                    }
                    else if (da.errno == 1000001) {
                        dialog.alert("请关闭滴滴司机端，重新打开后，即可正常使用");
                    } else {
                        dialog.alert(da.errmsg);
                    }
                },
                failFunc: function () {
                    loading.hide();
                    dialog.alert("请稍后再试");
                }
            });
        }

        //提交
        btnBox.addEventListener("click", function () {
            cardInput.blur();
            var loading = dd.dialog.loading("加载中...");
            if (have_driver_area == 0) {//没填
                submitData.province_id = capital.value;//省id
                submitData.city_id = city.value;//市id
                submitData.district_id = district.value;//区id
                if (submitData.province_id == 0 || submitData.city_id == 0 || submitData.district_id == 0) {
                    dialog.alert("请填写车辆所属地区");
                    return;
                }
            }
            if (have_card_number == 0) {//没填
                submitData.id_card = cardInput.value;
                if (!submitData.id_card) {
                    dialog.alert("请填写身份证号");
                    return;
                }
            }

            base.ajax({
                method: "post",
                url: baseUrl + "/api/v2/d_register/idCardSubmit",
                data: submitData,
                succFunc: function (data) {
                    loading.hide();
                    var da = base.txtToJson(data);
                    if (da.errno == 0) {
                        var opts = {
                            icon: {
                                url: "http://static.xiaojukeji.com/webapp/images/i-plaint.png",
                                width: "8px",
                                height: "36px"
                            },
                            title: "提交成功",
                            btn: {
                                val: "知道了",
                                handler: function () {
                                    cardInputBox.classList.remove("show");
                                    cardInputBox.classList.add("hide");

                                    areaSelectBox.classList.remove("show");
                                    areaSelectBox.classList.add("hide");

                                    btnBox.classList.remove("show");
                                    btnBox.classList.add("hide");

                                    idCardInfoFn();
                                }
                            }
                        };
                        dialog.alert(opts);

                    } else {
                        dialog.alert(da.errmsg);
                    }

                },
                failFunc: function () {
                    loading.hide();
                    dialog.alert("请稍后再试");
                }
            });
        }, false);


        //城市列表
        function getCity() {
            var loading = dd.dialog.loading("加载中...");
            base.ajax({
                method: "get",
                url: baseUrl + "/api/v2/d_register/new_get_all_city" + location.search,
                succFunc: function (data) {
                    loading.hide();
                    var da = base.txtToJson(data);
                    if (da.errno == 0) {
                        capitalJson = da.data;


                    } else {
                        dialog.alert("请稍后再试");
                    }

                },
                failFunc: function () {
                    loading.hide();
                    dialog.alert("请稍后再试");
                }
            });
        }

        //省 事件
        capital.addEventListener("touchend", initCity, false);
        function initCity() {
            capitalSelectedFn();
            citySelectedFn();
            districtSelectedFn();
            capital.removeEventListener("touchend", initCity);
        }

        capital.addEventListener("change", function () {
            citySelectedFn();
            districtSelectedFn();
        }, false);

        //市 事件
        city.addEventListener("change", function () {

            districtSelectedFn();
        }, false);


        city.addEventListener('focus', function () {//为了解决iPhone没有数据的时候也会出发option弹出

            if (!document.querySelector('#city option')) {
                this.blur();
            } else {
                this.click();
            }
        });

        //区 事件
        district.addEventListener('focus', function () {//为了解决iPhone没有数据的时候也会出发option弹出

            if (!document.querySelector('#district option')) {
                this.blur();
            }
        });

        //省 展示
        function capitalSelectedFn() {
            var capitalHtml = "";

            for (var i = 0; i < capitalJson.length; i++) {
                capitalHtml += "<option value = " + capitalJson[i].id + ">" + capitalJson[i].name + "</option>";
            }
            capital.innerHTML = capitalHtml;
        }

        //市 展示
        function citySelectedFn() {
            for (var j = 0; j < capitalJson.length; j++) {
                if (capital.value == capitalJson[j].id) {
                    var cityHtml = "";
                    cityJson = capitalJson[j].childs;
                    for (var m = 0; m < cityJson.length; m++) {
                        cityHtml += "<option value = " + cityJson[m].id + ">" + cityJson[m].name + "</option>";
                    }
                    city.innerHTML = cityHtml;
                }

            }
        }

        //区 展示
        function districtSelectedFn() {
            for (var m = 0; m < cityJson.length; m++) {
                if (city.value == cityJson[m].id) {
                    var districtHtml = "";
                    districtJson = cityJson[m].childs;
                    for (var n = 0; n < districtJson.length; n++) {
                        districtHtml += "<option value = " + districtJson[n].id + ">" + districtJson[n].name + "</option>"

                    }
                    district.innerHTML = districtHtml;
                    return;
                }
            }
        }

        //判断版本号：比较的版本，标准版本
        function getComp(versionCode, standardVersionCode) {
            if (versionCode === standardVersionCode) {
                return 0
            }
            var firstGroup = /([0-9]{1,})/img.exec(versionCode);
            var standardGroup = /([0-9]{1,})/img.exec(standardVersionCode);
            if (!firstGroup) {
                return -1
            } else {
                if (!standardGroup) {
                    return 1
                }
            }
            var firstCode = parseInt(firstGroup[1]);
            var standardCode = parseInt(standardGroup[1]);
            if (firstCode > standardCode) {
                return 1
            } else {
                if (firstCode < standardCode) {
                    return -1
                } else {
                    if (versionCode.length - firstCode.length == 0) {
                        return -1
                    } else {
                        if (standardVersionCode.length - standardCode.length == 0) {
                            return 1
                        }
                    }
                    var firstNextString = versionCode.substr(firstCode.toString().length, versionCode.length).replace(/^\./, "");
                    var standardNextString = standardVersionCode.substr(standardCode.toString().length, standardVersionCode.length).replace(/^\./, "");
                    return getComp(firstNextString, standardNextString)
                }
            }
        };

        //是否支持版本
        function isApply() {
            var temp = getComp(base.getQueryStr().appversion, '2.9.96');//TODO
            if (temp < 0) {
                alertFn();
                function alertFn() {
                    var opts = {
                        icon: {
                            url: "http://static.xiaojukeji.com/webapp/images/i-plaint.png",
                            width: "8px",
                            height: "36px"
                        },
                        title: "您当前使用的司机端版本过低，请更新App版本后再补充资料",
                        btn: {
                            val: "立即下载",
                            handler: function () {
                                alertFn();
                                base.diffPlatform({
                                    android: function () {
                                        location.replace("http://dldir1.qq.com/diditaxi/driver/and/2_9_96/didi_siji2996_v57_190851.apk");
                                    },
                                    ios: function () {
                                        location.replace("https://itunes.apple.com/cn/app/di-di-si-ji-chu-zu-che/id564454984?mt=8");
                                    }
                                });

                            }
                        }
                    };
                    dialog.alert(opts);
                }

            }
        };

    }, false);


</script>